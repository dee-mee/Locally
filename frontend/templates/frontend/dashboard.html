{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard{% endblock %}

{% block extra_css %}
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
body {
    background: linear-gradient(135deg, #20105a 0%, #2a266d 100%) !important;
    font-family: 'Inter', sans-serif;
    color: #fff;
}
.dashboard-wrapper {
    display: flex;
    min-height: 100vh;
}
.sidebar {
    width: 260px;
    background: linear-gradient(135deg, #2a266d 60%, #20105a 100%);
    padding: 2rem 1.5rem 1rem 1.5rem;
    display: flex;
    flex-direction: column;
    border-radius: 20px 0 0 20px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.25);
}
.sidebar .logo {
    font-size: 1.6rem;
    font-weight: 700;
    margin-bottom: 2.5rem;
    display: flex;
    align-items: center;
    gap: 0.8rem;
}
.sidebar .logo i {
    color: #ffd700;
    font-size: 2rem;
}
.sidebar .menu {
    flex: 1;
}
.sidebar .menu ul {
    list-style: none;
    padding: 0;
    margin: 0;
}
.sidebar .menu li {
    margin-bottom: 1.2rem;
}
.sidebar .menu a {
    color: #b2b6d9;
    text-decoration: none;
    font-weight: 500;
    font-size: 1.1rem;
    display: flex;
    align-items: center;
    gap: 0.7rem;
    border-radius: 6px;
    padding: 0.55rem 1rem;
    transition: background 0.2s, color 0.2s;
}
.sidebar .menu a.active, .sidebar .menu a:hover {
    background: rgba(255,255,255,0.07);
    color: #fff;
}
.sidebar .go-pro {
    background: linear-gradient(120deg, #4b33a8, #20105a 80%);
    border-radius: 12px;
    padding: 1.2rem 1rem;
    margin-top: 2rem;
    text-align: center;
    color: #fff;
    box-shadow: 0 4px 24px rgba(75,51,168,0.15);
}
.sidebar .go-pro .crown {
    font-size: 2rem;
    color: #ffd700;
    margin-bottom: 0.5rem;
}
.sidebar .go-pro .upgrade-btn {
    margin-top: 1rem;
    background: #ffd700;
    color: #2a266d;
    font-weight: 600;
    border: none;
    border-radius: 6px;
    padding: 0.5rem 1.2rem;
    cursor: pointer;
    box-shadow: 0 2px 10px rgba(255,215,0,0.07);
    transition: background 0.2s, color 0.2s;
}
.sidebar .go-pro .upgrade-btn:hover {
    background: #ffe066;
}

.main-content {
    flex: 1;
    padding: 3.5rem 3.5rem 3.5rem 1.5rem;
    display: flex;
    flex-direction: column;
    min-width: 0;
}
.topbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 2rem;
}
.topbar .search {
    background: #251d4a;
    border-radius: 8px;
    padding: 0.4rem 1rem;
    display: flex;
    align-items: center;
    gap: 0.7rem;
    color: #b2b6d9;
    font-size: 1rem;
    border: none;
    outline: none;
    width: 220px;
}
.topbar .user {
    display: flex;
    align-items: center;
    gap: 0.8rem;
}
.topbar .user .avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid #ffd700;
}

.stats-cards {
    display: flex;
    gap: 2.2rem;
    margin-bottom: 2.5rem;
    margin-top: 0.5rem;
    flex-wrap: wrap;
}
.stats-card {
    flex: 1 1 220px;
    background: linear-gradient(120deg, #2a266d 60%, #4b33a8 100%);
    border-radius: 16px;
    padding: 1.1rem 1.3rem 1.1rem 1.3rem;
    box-shadow: 0 2px 12px rgba(75,51,168,0.18);
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    color: #fff;
    position: relative;
    min-width: 210px;
    margin-bottom: 0.5rem;
    min-height: 180px;
    justify-content: center;
}
.card-dark {
    background: linear-gradient(120deg, #2a266d 60%, #4b33a8 100%);
    border-radius: 20px;
    padding: 2.2rem 2.5rem 2.2rem 2.5rem;
    box-shadow: 0 4px 24px rgba(75,51,168,0.13);
    color: #fff;
    margin-bottom: 0.5rem;
    min-height: 180px;
    display: flex;
    flex-direction: column;
    justify-content: center;
}
.stats-card .icon {
    position: absolute;
    top: 1.2rem;
    right: 1.5rem;
    font-size: 2.2rem;
    opacity: 0.18;
}
.stats-card .label {
    font-size: 1rem;
    color: #b2b6d9;
    font-weight: 500;
}
.stats-card .value {
    font-size: 2rem;
    font-weight: 700;
    letter-spacing: 1px;
}
.stats-card .desc {
    font-size: 1.1rem;
    color: #ffd700;
    font-weight: 600;
}

.dashboard-grid {
    display: grid;
    grid-template-columns: 1.1fr 1.8fr;
    gap: 2.5rem;
    margin-top: 1.5rem;
    align-items: start;
}
.dashboard-grid .left, .dashboard-grid .right {
    display: flex;
    flex-direction: column;
    gap: 2.2rem;
}
.card-dark {
    background: linear-gradient(120deg, #2a266d 60%, #4b33a8 100%);
    border-radius: 20px;
    padding: 2.2rem 2.5rem 2.2rem 2.5rem;
    box-shadow: 0 4px 24px rgba(75,51,168,0.13);
    color: #fff;
    margin-bottom: 0.5rem;
    
}
.card-dark h4, .card-dark h5 {
    color: #fff;
    margin-bottom: 1.2rem;
}

.table-dark {
    width: 100%;
    color: #fff;
    border-radius: 10px;
    background: transparent;
    font-size: 1.02rem;
    border-spacing: 0 0.5rem;
    margin-top: 0.7rem;
    margin-bottom: 0.5rem;
}
.table-dark th, .table-dark td {
    border: none;
    padding: 0.7rem 0.5rem;
}
.table-dark thead th {
    color: #ffd700;
    font-weight: 600;
    background: none;
}
.table-dark tbody tr {
    border-radius: 10px;
    background: rgba(255,255,255,0.03);
    margin-bottom: 0.3rem;
}
.table-dark tbody tr:last-child {
    border-bottom: none;
}
.status-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 6px;
}
.status-success { background: #10b981; }
.status-warning { background: #f59e0b; }
.status-danger { background: #ef4444; }

@media (max-width: 1200px) {
    .dashboard-grid {
        grid-template-columns: 1fr;
    }
}
@media (max-width: 900px) {
    .dashboard-wrapper {
        flex-direction: column;
    }
    .sidebar {
        width: 100%;
        border-radius: 0 0 20px 20px;
        flex-direction: row;
        align-items: flex-start;
        gap: 1rem;
    }
    .main-content {
        padding: 1rem;
    }
    .stats-cards {
        flex-direction: column;
        gap: 1rem;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="dashboard-wrapper">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="logo">
      <i class="fas fa-crown"></i>
      SMART POS
    </div>
    <nav class="menu">
      <ul>
        <li><a href="{% url 'frontend:dashboard' %}" class="{% if request.resolver_match.url_name == 'dashboard' %}active{% endif %}"><i class="fas fa-th-large"></i> Dashboard</a></li>
        <li><a href="{% url 'pos:sale_list' %}" class="{% if request.resolver_match.app_name == 'pos' and request.resolver_match.url_name in 'sale_list sale_detail sale_create' %}active{% endif %}"><i class="fas fa-receipt"></i> Sales</a></li>
        <li><a href="{% url 'inventory:product_list' %}" class="{% if request.resolver_match.app_name == 'inventory' and request.resolver_match.url_name in 'product_list product_detail product_add' %}active{% endif %}"><i class="fas fa-box"></i> Products</a></li>
        <li><a href="{% url 'customers:customer_list' %}" class="{% if request.resolver_match.app_name == 'customers' %}active{% endif %}"><i class="fas fa-users"></i> Customers</a></li>
        <li><a href="{% url 'reports:report_list' %}" class="{% if request.resolver_match.app_name == 'reports' %}active{% endif %}"><i class="fas fa-chart-bar"></i> Reports</a></li>
        <li><a href="{% url 'frontend:logout' %}"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
        <li><a href="#"><i class="fas fa-layer-group"></i> Data Classification</a></li>
      </ul>
    </nav>

  </aside>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Topbar -->
    <div class="topbar">
      <input class="search" type="text" placeholder="Search..." />
      <div style="font-size:1.2rem;font-weight:600;">Dashboard</div>
      <div class="user">
        <span>{{ request.user.get_full_name|default:request.user.username }}</span>
        <img class="avatar" src="https://randomuser.me/api/portraits/men/32.jpg" alt="User" />
      </div>
    </div>
    <!-- Stats Cards -->
    <div class="stats-cards">
      <div class="stats-card">
        <span class="icon"><i class="fas fa-coins"></i></span>
        <span class="label">Total Revenue</span>
        <span class="value">${{ total_revenue|floatformat:2 }}</span>
        <span class="desc">+{{ weekly_sales.total_sales|default:0|floatformat:2 }} this week</span>
      </div>
      <div class="stats-card">
        <span class="icon"><i class="fas fa-bolt"></i></span>
        <span class="label">Today's Sales</span>
        <span class="value">{{ today_sales.total_items|default:0 }}</span>
        <span class="desc">+${{ today_sales.total_sales|default:0|floatformat:2 }} today</span>
      </div>
    </div>
    <!-- Main Analytics Grid -->
    <div class="dashboard-grid">
      <div class="left">
        <div class="card-dark">
          <h4>Total Revenue</h4>
          <canvas id="revenueDoughnut" height="160"></canvas>
          <div style="margin-top:1.2rem;">
            <span style="font-size:1.1rem;color:#ffd700;font-weight:600;">75%</span> of sales made today<br>
            <span style="color:#b2b6d9;font-size:0.98rem;">Yesterday: $1719</span>
          </div>
        </div>
        <div class="card-dark">
          <h5>Top 5 Users Balances</h5>
          <table class="table-dark">
            <tbody>
              {% for customer in top_customers %}
              <tr>
                <td>
                  <img src="https://randomuser.me/api/portraits/lego/{{ forloop.counter }}.jpg" style="width:32px;border-radius:50%;margin-right:8px;">
                  {{ customer.get_full_name }}
                </td>
                <td style="color:#ffd700;">{{ customer.customer_type|title }}</td>
                <td>{{ customer.total_orders }}</td>
                <td>${{ customer.total_spent|floatformat:2 }}</td>
              </tr>
              {% empty %}
              <tr><td colspan="4">No customer data.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      <div class="right">
        <div class="card-dark">
          <h4>Sales Analytics</h4>
          <div style="display:flex;gap:1.2rem;align-items:center;margin-bottom:1.2rem;">
            <button class="upgrade-btn" style="padding:0.25rem 1rem;font-size:0.98rem;">Daily</button>
            <button class="upgrade-btn" style="padding:0.25rem 1rem;font-size:0.98rem;background:#fff;color:#4b33a8;">Weekly</button>
            <button class="upgrade-btn" style="padding:0.25rem 1rem;font-size:0.98rem;">Monthly</button>
          </div>
          <canvas id="salesChart" height="120"></canvas>
        </div>
        <div class="card-dark">
          <h5>Revenue History</h5>
          <table class="table-dark">
            <thead>
              <tr>
                <th>Market</th>
                <th>Date</th>
                <th>Type</th>
                <th>Status</th>
                <th>Amount</th>
              </tr>
            </thead>
            <tbody>
              {% for sale in revenue_history %}
              <tr>
                <td>{{ sale.customer.company_name|default:sale.customer.get_full_name|default:'Walk-in' }}</td>
                <td>{{ sale.created_at|date:"M d, Y" }}</td>
                <td>
                  {% if sale.status == 'completed' %}
                    <span style="color:#10b981;font-weight:600;">Deposit</span>
                  {% elif sale.status == 'pending' %}
                    <span style="color:#f59e0b;font-weight:600;">Payout</span>
                  {% elif sale.status == 'refunded' %}
                    <span style="color:#ef4444;font-weight:600;">Refund</span>
                  {% else %}
                    <span style="color:#b2b6d9;font-weight:600;">Other</span>
                  {% endif %}
                </td>
                <td>
                  {% if sale.status == 'completed' %}
                    <span class="status-dot status-success"></span> Success
                  {% elif sale.status == 'pending' %}
                    <span class="status-dot status-warning"></span> Pending
                  {% elif sale.status == 'refunded' %}
                    <span class="status-dot status-danger"></span> Refunded
                  {% else %}
                    <span class="status-dot"></span> {{ sale.get_status_display }}
                  {% endif %}
                </td>
                <td>${{ sale.total|floatformat:2 }}</td>
              </tr>
              {% empty %}
              <tr><td colspan="5">No revenue history.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </main>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.3/dist/chart.umd.min.js"></script>
<script>
// Revenue Doughnut Chart
const doughnutCtx = document.getElementById('revenueDoughnut').getContext('2d');
new Chart(doughnutCtx, {
  type: 'doughnut',
  data: {
    labels: ['Today', 'This Week'],
    datasets: [{
      data: JSON.parse('{{ doughnut_chart_data|safe }}'),
      backgroundColor: ['#ffd700', '#2a266d'],
      borderWidth: 0,
    }]
  },
  options: {
    cutout: '75%',
    plugins: {
      legend: { display: false },
      tooltip: { enabled: false }
    }
  }
});

// Sales Analytics Chart
const salesCtx = document.getElementById('salesChart').getContext('2d');
new Chart(salesCtx, {
  type: 'bar',
  data: {
    labels: JSON.parse('{{ sales_chart_labels|safe }}'),
    datasets: [
      {
        label: 'Sales',
        data: JSON.parse('{{ sales_chart_data|safe }}'),
        backgroundColor: 'rgba(67, 97, 238, 0.7)',
        borderRadius: 8,
        maxBarThickness: 28
      },
      {
        type: 'line',
        label: 'Conversion',
        data: JSON.parse('{{ conversion_chart_data|safe }}'),
        borderColor: '#ffd700',
        borderWidth: 2,
        fill: false,
        tension: 0.4,
        pointRadius: 4,
        yAxisID: 'y1'
      }
    ]
  },
  options: {
    plugins: { legend: { labels: { color: '#fff' } } },
    scales: {
      x: { ticks: { color: '#b2b6d9' }, grid: { display: false } },
      y: { ticks: { color: '#b2b6d9' }, grid: { color: '#251d4a' } },
      y1: {
        position: 'right',
        grid: { drawOnChartArea: false },
        ticks: { color: '#ffd700', callback: v => v + '%' }
      }
    }
  }
});
</script>
{% endblock %}
